name: Daily Cron Job

on:
  schedule:
    # Every 1 minute for testing â€” change later
    - cron: "*/10 * * * *"

  workflow_dispatch:

jobs:
  run-cron:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Load repo
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Export secrets into env
      # -----------------------------
      - name: Load secrets into env
        run: |
          echo "MONGO_URI=${{ secrets.MONGO_URI }}" >> $GITHUB_ENV
          echo "CRON_JOB_ENABLED=${{ secrets.CRON_JOB_ENABLED }}" >> $GITHUB_ENV
          echo "SERVER_STORAGE=${{ secrets.SERVER_STORAGE }}" >> $GITHUB_ENV
          echo "MAIL_SEND_ENABLED=${{ secrets.MAIL_SEND_ENABLED }}" >> $GITHUB_ENV
          echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> $GITHUB_ENV
          echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> $GITHUB_ENV
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
          echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> $GITHUB_ENV
          echo "EMAIL_CC=${{ secrets.EMAIL_CC }}" >> $GITHUB_ENV
          echo "EMAIL_TO=${{ secrets.EMAIL_TO }}" >> $GITHUB_ENV
          echo "EXPORT_FORMAT=${{ secrets.EXPORT_FORMAT }}" >> $GITHUB_ENV
          echo "COLLECTION_NAME=${{ secrets.COLLECTION_NAME }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV


      # -----------------------------
      # Check if CRON is enabled
      # -----------------------------
      - name: Print cron status
        run: echo "CRON_JOB_ENABLED = $CRON_JOB_ENABLED"

      # -----------------------------
      # Stop job if CRON disabled
      # -----------------------------
      - name: Stop if disabled
        if: env.CRON_JOB_ENABLED != 'true'
        run: |
          echo "Cron is disabled. Stopping job."
          exit 0

      # -----------------------------
      # Install Node dependencies
      # -----------------------------
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      # -----------------------------
      # Run your script
      # -----------------------------
      - name: Run script
        run: npm start

      # -----------------------------
      # Finished
      # -----------------------------
      - name: Done
        run: echo "Cron job finished successfully"
